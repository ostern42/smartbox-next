<!DOCTYPE html>
<html>
<head>
    <title>SmartBox WebRTC Test - Fixed</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 20px;
            background: #f3f3f3;
        }
        #video {
            width: 640px;
            height: 480px;
            background: #000;
            border: 2px solid #0078d4;
            border-radius: 8px;
            display: block;
        }
        button {
            margin: 10px 5px;
            padding: 10px 20px;
            font-size: 16px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #106ebe;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #status {
            margin-top: 20px;
            padding: 10px;
            background: #fff;
            border-radius: 4px;
            font-family: 'Cascadia Code', monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        #fpsCounter {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: #00ff00;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: 'Cascadia Code', monospace;
            font-size: 16px;
            display: none;
        }
        .info {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>SmartBox WebRTC Test - 70 FPS Target!</h1>
    
    <div class="info">
        ✅ Dieser Test zeigt die WebRTC-Kamera ohne Reset-Probleme
    </div>
    
    <video id="video" autoplay playsinline></video>
    
    <div>
        <button id="startBtn" onclick="startWebcam()">Start Webcam</button>
        <button id="stopBtn" onclick="stopWebcam()" disabled>Stop Webcam</button>
        <button onclick="showStats()">Show Stats</button>
    </div>
    
    <div id="status">Ready to test WebRTC...</div>
    <div id="fpsCounter">FPS: <span id="fps">0</span></div>
    
    <script>
        let stream = null;
        let animationId = null;
        
        async function startWebcam() {
            try {
                addStatus('Requesting camera access...');
                document.getElementById('startBtn').disabled = true;
                
                // Request high frame rate
                const constraints = {
                    video: {
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        frameRate: { ideal: 60, min: 30 }
                    },
                    audio: false
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('video');
                video.srcObject = stream;
                
                // Wait for video to be ready
                video.onloadedmetadata = () => {
                    // Get actual settings
                    const track = stream.getVideoTracks()[0];
                    const settings = track.getSettings();
                    
                    addStatus(`✅ Webcam started successfully!`);
                    addStatus(`Resolution: ${settings.width}x${settings.height}`);
                    addStatus(`Frame Rate: ${settings.frameRate} FPS`);
                    addStatus(`Device: ${track.label}`);
                    
                    // Enable/disable buttons
                    document.getElementById('stopBtn').disabled = false;
                    document.getElementById('startBtn').disabled = true;
                    
                    // Start FPS monitoring
                    startFPSMonitoring();
                };
                
            } catch (error) {
                addStatus(`❌ Error: ${error.message}`);
                document.getElementById('startBtn').disabled = false;
            }
        }
        
        function stopWebcam() {
            if (stream) {
                // Stop all tracks
                stream.getTracks().forEach(track => {
                    track.stop();
                    addStatus(`Stopped track: ${track.kind}`);
                });
                
                // Clear video
                const video = document.getElementById('video');
                video.srcObject = null;
                stream = null;
                
                // Stop FPS monitoring
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }
                
                // Update UI
                document.getElementById('fpsCounter').style.display = 'none';
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                
                addStatus('✅ Webcam stopped');
            }
        }
        
        function startFPSMonitoring() {
            document.getElementById('fpsCounter').style.display = 'block';
            let frameCount = 0;
            let lastTime = performance.now();
            
            function updateFPS() {
                if (!stream) return;
                
                frameCount++;
                const currentTime = performance.now();
                const elapsed = currentTime - lastTime;
                
                if (elapsed >= 1000) {
                    const fps = Math.round((frameCount * 1000) / elapsed);
                    document.getElementById('fps').textContent = fps;
                    frameCount = 0;
                    lastTime = currentTime;
                }
                
                animationId = requestAnimationFrame(updateFPS);
            }
            
            animationId = requestAnimationFrame(updateFPS);
        }
        
        async function showStats() {
            if (!stream) {
                addStatus('No active stream');
                return;
            }
            
            const track = stream.getVideoTracks()[0];
            const settings = track.getSettings();
            const capabilities = track.getCapabilities();
            
            addStatus('=== Current Settings ===');
            addStatus(JSON.stringify(settings, null, 2));
            addStatus('=== Capabilities ===');
            addStatus(JSON.stringify(capabilities, null, 2));
        }
        
        function addStatus(message) {
            const status = document.getElementById('status');
            const timestamp = new Date().toLocaleTimeString();
            status.textContent = `[${timestamp}] ${message}\n` + status.textContent;
            
            // Keep only last 10 messages
            const lines = status.textContent.split('\n');
            if (lines.length > 10) {
                status.textContent = lines.slice(0, 10).join('\n');
            }
        }
        
        // Initialize
        window.addEventListener('load', () => {
            addStatus('Page loaded. Click "Start Webcam" to begin.');
            
            // Check if getUserMedia is available
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                addStatus('❌ WebRTC not supported in this browser!');
                document.getElementById('startBtn').disabled = true;
            }
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopWebcam();
        });
    </script>
</body>
</html>