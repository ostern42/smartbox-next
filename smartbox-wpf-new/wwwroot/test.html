<!DOCTYPE html>
<html>
<head>
    <title>SmartBox WebRTC Test</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 20px;
            background: #f3f3f3;
        }
        #video {
            width: 640px;
            height: 480px;
            background: #000;
            border: 2px solid #0078d4;
            border-radius: 8px;
        }
        button {
            margin: 10px 5px;
            padding: 10px 20px;
            font-size: 16px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #106ebe;
        }
        #status {
            margin-top: 20px;
            padding: 10px;
            background: #fff;
            border-radius: 4px;
            font-family: 'Cascadia Code', monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>SmartBox WebRTC Test - 70 FPS Target!</h1>
    
    <video id="video" autoplay playsinline></video>
    
    <div>
        <button onclick="startWebcam()">Start Webcam</button>
        <button onclick="stopWebcam()">Stop Webcam</button>
        <button onclick="showStats()">Show Stats</button>
    </div>
    
    <div id="status">Ready to test WebRTC...</div>
    
    <script>
        let stream = null;
        let statsInterval = null;
        let fpsDisplay = null;
        
        async function startWebcam() {
            try {
                updateStatus('Requesting camera access...');
                
                // Request high frame rate
                const constraints = {
                    video: {
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        frameRate: { ideal: 60, min: 30 }
                    },
                    audio: false
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                document.getElementById('video').srcObject = stream;
                
                // Get actual settings
                const track = stream.getVideoTracks()[0];
                const settings = track.getSettings();
                
                updateStatus(`Webcam started!\nResolution: ${settings.width}x${settings.height}\nFrame Rate: ${settings.frameRate} FPS\nDevice: ${track.label}`);
                
                // Start monitoring stats
                startStatsMonitoring();
                
            } catch (error) {
                updateStatus(`Error: ${error.message}`);
            }
        }
        
        function stopWebcam() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                document.getElementById('video').srcObject = null;
                updateStatus('Webcam stopped');
                
                if (fpsDisplay) {
                    fpsDisplay.remove();
                    fpsDisplay = null;
                }
            }
        }
        
        function startStatsMonitoring() {
            let frameCount = 0;
            let lastTime = performance.now();
            
            // Use requestAnimationFrame for accurate FPS counting
            function countFrames() {
                if (!stream) return;
                
                frameCount++;
                const currentTime = performance.now();
                const elapsed = currentTime - lastTime;
                
                if (elapsed >= 1000) {
                    const fps = Math.round((frameCount * 1000) / elapsed);
                    // Update FPS display without changing main status
                    if (!fpsDisplay) {
                        fpsDisplay = document.createElement('div');
                        fpsDisplay.style.cssText = 'position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: #00ff00; padding: 8px; border-radius: 4px; font-family: monospace;';
                        document.body.appendChild(fpsDisplay);
                    }
                    fpsDisplay.textContent = `FPS: ${fps}`;
                    frameCount = 0;
                    lastTime = currentTime;
                }
                
                requestAnimationFrame(countFrames);
            }
            
            requestAnimationFrame(countFrames);
        }
        
        async function showStats() {
            if (!stream) {
                updateStatus('No active stream');
                return;
            }
            
            const track = stream.getVideoTracks()[0];
            const settings = track.getSettings();
            const capabilities = track.getCapabilities();
            
            const stats = {
                current: settings,
                capabilities: capabilities
            };
            
            updateStatus(JSON.stringify(stats, null, 2));
        }
        
        function updateStatus(message) {
            const status = document.getElementById('status');
            const timestamp = new Date().toLocaleTimeString();
            status.textContent = `[${timestamp}] ${message}`;
        }
        
        // Auto-start on load
        window.addEventListener('load', () => {
            updateStatus('Page loaded. Click "Start Webcam" to begin.');
        });
    </script>
</body>
</html>